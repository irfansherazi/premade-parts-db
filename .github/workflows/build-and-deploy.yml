name: Build and Deploy Database

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Database version number (leave empty to auto-increment)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'seeder/**'
      - 'src/**'
      - 'prisma/**'

jobs:
  build-and-upload:
    runs-on: windows-2025
    environment: production

    env:
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      PREMADE_DATABASE_URL: file:${{ github.workspace }}/premade-database.db

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22.18.0"

      - name: Install AWS CLI
        run: |
          aws --version

      - name: Install dependencies
        run: |
          npm install

      - name: Set up AWS credentials
        run: |
          $awsCredentials = @"
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region = ${{ vars.AWS_REGION }}
          "@
          New-Item -Path $env:USERPROFILE -Name .aws -ItemType Directory -Force
          Set-Content -Path "$env:USERPROFILE\.aws\credentials" -Value $awsCredentials

      - name: Generate Prisma Client
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          $env:PREMADE_DATABASE_URL = "file:$dbPath"
          npx prisma generate

      - name: Clean existing database (if any)
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          $journalPath = "${{ github.workspace }}/premade-database.db-journal"
          $shmPath = "${{ github.workspace }}/premade-database.db-shm"
          $walPath = "${{ github.workspace }}/premade-database.db-wal"
          if (Test-Path $dbPath) {
            Remove-Item $dbPath -Force
          }
          if (Test-Path $journalPath) {
            Remove-Item $journalPath -Force
          }
          if (Test-Path $shmPath) {
            Remove-Item $shmPath -Force
          }
          if (Test-Path $walPath) {
            Remove-Item $walPath -Force
          }

      - name: Run Prisma Migrations
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          $env:PREMADE_DATABASE_URL = "file:$dbPath"
          npx prisma migrate deploy

      - name: Run Database Seeder
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          $env:PREMADE_DATABASE_URL = "file:$dbPath"
          npm run seed

      - name: Verify database file exists
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          if (-not (Test-Path $dbPath)) {
            Write-Error "Database file not found at $dbPath"
            exit 1
          }
          $fileSize = (Get-Item $dbPath).Length
          Write-Host "Database file size: $fileSize bytes"

      - name: Get next version number
        id: get_version
        shell: pwsh
        run: |
          $env:AWS_SDK_LOAD_CONFIG = 1
          $bucket = "xoarmor-desktop-installation-files-staging"
          $prefix = "xoarmor-premade-parts-db/"
          
          try {
            $result = aws s3api list-objects-v2 --bucket $bucket --prefix $prefix --query "Contents[?contains(Key, 'xoarmor-premade-parts-db-v')].Key" --output text
            $latestVersion = 0
            
            if ($result) {
              $keys = $result -split "`n" | Where-Object { $_ -ne "" }
              foreach ($key in $keys) {
                $fileName = $key.Split("/")[-1]
                if ($fileName -match "xoarmor-premade-parts-db-v(\d+)\.zip") {
                  $version = [int]$matches[1]
                  if ($version -gt $latestVersion) {
                    $latestVersion = $version
                  }
                }
              }
            }
            
            $nextVersion = $latestVersion + 1
            Write-Host "Latest version: $latestVersion"
            Write-Host "Next version: $nextVersion"
            "VERSION=$nextVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "VERSION=$nextVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } catch {
            Write-Host "No existing versions found, starting at version 1"
            "VERSION=1" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "VERSION=1" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Override version if provided
        if: ${{ github.event.inputs.version != '' }}
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          Write-Host "Using provided version: $version"
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create zip file
        shell: pwsh
        run: |
          $dbPath = "${{ github.workspace }}/premade-database.db"
          $zipPath = "${{ github.workspace }}/xoarmor-premade-parts-db-v$env:VERSION.zip"
          
          Write-Host "Creating zip file: $zipPath"
          Compress-Archive -Path $dbPath -DestinationPath $zipPath -Force
          
          $zipSize = (Get-Item $zipPath).Length
          Write-Host "Zip file size: $zipSize bytes"
          "ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload to S3
        shell: pwsh
        run: |
          $env:AWS_SDK_LOAD_CONFIG = 1
          $zipPath = $env:ZIP_PATH
          $bucket = "xoarmor-desktop-installation-files-staging"
          $key = "xoarmor-premade-parts-db/xoarmor-premade-parts-db-v$env:VERSION.zip"
          $version = $env:VERSION
          
          Write-Host "Uploading $zipPath to s3://$bucket/$key"
          
          # Use AWS CLI for reliable upload
          aws s3 cp $zipPath "s3://$bucket/$key" --region ${{ vars.AWS_REGION }}
          
          Write-Host "Successfully uploaded database version $version to S3"

      - name: Clean up AWS credentials
        if: always()
        run: |
          Remove-Item -Path "$env:USERPROFILE\.aws" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Teams Success Notification
        if: success()
        shell: pwsh
        run: |
          $version = $env:VERSION
          $body = @{
            buildNumber = "${{ github.run_number }}"
            status = "SUCCESS"
            message = "Premade database v$version built and uploaded successfully!"
            version = $version
            buildLogsUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } | ConvertTo-Json
          
          if ("${{ secrets.TEAMS_WEBHOOK_URL }}" -ne "") {
            Invoke-RestMethod -Uri "${{ secrets.TEAMS_WEBHOOK_URL }}" -Method Post -Body $body -ContentType "application/json"
          }

      - name: Teams Failure Notification
        if: failure()
        shell: pwsh
        run: |
          $body = @{
            buildNumber = "${{ github.run_number }}"
            status = "FAILED"
            message = "Premade database build failed. Please check the logs."
            buildLogsUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } | ConvertTo-Json
          
          if ("${{ secrets.TEAMS_WEBHOOK_URL }}" -ne "") {
            Invoke-RestMethod -Uri "${{ secrets.TEAMS_WEBHOOK_URL }}" -Method Post -Body $body -ContentType "application/json"
          }

